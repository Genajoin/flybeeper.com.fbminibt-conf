# FlyBeeper Remote Control 4

## Инструкция

### Режимы работы

Устройство работает в нескольких режимах.

Первый режим - ожидание подключения по Bluetooth. Каждые 4 секунды устройство отправляет рекламный пакет, благодаря которому оно может быть обнаружено для инициализации подключения. В промежутках между рекламными пакетами устройство находится в спящем режиме. Время нахождения в данном режиме ограниченно лишь уровнем заряда батареи. Уровень энергопотребления незначительный, что дает возможность работать в этом режиме на протяжении всего летного сезона.

Как только устройство получает запрос на подключение, активируется второй режим. Имя устройства FBRC4. После установления связи возможно прочитать уровень батареи и подписаться на изменение значений датчиков. В последнем случае активируется периодическое считывание данных с необходимых датчиков. В промежутках устройство находится в спящем режиме. При отключении Bluetooth соединения устройство переходит обратно в режим ожидания с периодической передачей рекламных пакетов.

Режим переподключения. В случае потери соединения устройство на несколько минут переходит в режим с повышеной частотой отправки рекламных пакетов, что обеспечит быстрое переподключение. Также этот режим активируется сразу после смены батареи. Это можно использовать для ускорения процедуры первого подключения в вашем приложении.

### Управление

Устройство имеет 4 тактильные кнопки, но они используются только для передачи их состояния. Кнопки никак не управляют самим устройством. Сброс устройства осуществляется кратковременным выниманием батареи.

При вынимании батареи также сбрасывается информация о спаренном устройстве в режиме HID клавиатуры. Процедуру связывания нужно повторить предварительно отвязав устройство на смартфоне. Это также способ перепривязки к другому смартфону/планшету/ПК.

### Настройка

Протестировать устройство можно через графический интерфейс [конфигуратора](https://fbminibt-conf.flybeeper.com/settings). Необходим Bluetooth модуль, например, смартфон, ноутбук или ПК с Bluetooth модулем. Нажать `Connect` и выбрать из списка `FBRC4`. Держите устройства как можно ближе друг к другу. На странице `cockpit` можно увидеть изменения при нажании на кнопки FBRC4. На странице `settings` можно найти и изменить следующие настройки:

- `hid_keyboard_off` - режим внешней HID клавиатуры. При изменении данной настройки после нажатия на `Apply` необходимо вынуть и снова вставить батарею. Если флаг не стоит, то HID активируется и подключение потребует стандартной процедуры связывания устройств через интерфейс операционной системы. Помните, что устройство никогда не выключается. Вам нужно вручную разрывать соединение через интерфейс операционной системы после окончания использования. В противном случае операционная система будет держать соединение открытым и переподключаться при его разрыве. Это будет постепенно разряжать батарею. Если ваше приложение поддерживает чтение состояния кнопок через сервис AIOS, то HID следует выключить активировав данную настройку. Это продлит жизнь батареи.

- `char_button1,2,3,4` - коды кнопок HID для каждой из кнопок в режиме HID клавиатуры. По-умолчанию кнопкам присвоены коды клавиш F1,F2,F3,F4.
  Коды клавиш HID не соответствуют ASCII кодам. Для поиска соотвествий смотри таблицы 5, 6 в [Bluetooth HID Profile](https://cdn.sparkfun.com/datasheets/Wireless/Bluetooth/RN-HID-User-Guide-v1.0r.pdf)

### Список летных программ

- xcTrack (HID)
- xcSoar (HID)
- LK8000 (HID)

### Описание протокола связи

Данный раздел предназначен больше для разработчиков чем для обычных пользователей.

Устройство работает по протоколу BLE. Сопряжение и авторизация требуется только если настройка `hid_keyboard_off` не активна. Изменения каждого параметра доступны по подписке (дескриптор 0x2902). Все нестандартные параметры имеют 128 битный UUID, дискрипторы 0x2901 с текстовым именем параметра и 0x2904 с описанием формата, экспоненты и единицы измерения. Для удобства их значения приведены в таблицах ниже.

Характеристики UUID сервиса `0x1815` AIOS. Устройство имеет 4 кнопки. Это определено в дескрипторе 0x2909 Number of Digitals. Каждые два бита отвечают за состояние одной кнопки начиная с младшего. 0b00000001 — нажата кнопка 1, если нажать все кнопки одновременно, то получим значение 0b01010101. Значит весь массив умещается в одном байте. Используются лишь состояния 0b00 — отпущена и 0b01 — нажата. Подробнее о состояниях в Automation IO Service 1.0 Specification (п. 3.1.1). Уведомления оправляются по изменению, т.е. отдельное уведомление о нажатии и отдельное об отпускании кнопки. Это позволяет обнаруживать и долгий клик и двойной и одновременное удержание нескольких кнопок.

| Name    | UUID   | Size        |
| ------- | ------ | ----------- |
| Buttons | 0x2A56 | UINT8 array |

Характеристики UUID сервиса `0x180F` BAS

| Name            | UUID                                 | Size  | Exponent | Unit    |
| --------------- | ------------------------------------ | ----- | -------- | ------- |
| Battery level   | 0x2a19                               | UINT8 | 0        | Percent |
| Battery voltage | b0c889e8-16d2-45ef-b615-387f6bca2370 | INT16 | -3       | Volt    |

Характеристики UUID сервиса `0x180A` DevInfo

| Name              | UUID   | Size   | Value     |
| ----------------- | ------ | ------ | --------- |
| Model Number      | 0x2A24 | STRING | FBRC4     |
| Manufacturer Name | 0x2A29 | STRING | FlyBeeper |
| Firmware Revision | 0x2A26 | STRING | 0.01      |

Настройки прибора доступны для чтения и записи в сервисе `904baf04-5814-11ee-8c99-0242ac120000`. Каждая настройка имеет индивидуальный 128 битный UUID и дискрипторы 0x2901, 0x2904.

| Name             | UUID                                 | Size  | Value | Unit    |
| ---------------- | ------------------------------------ | ----- | ----- | ------- |
| hid_keyboard_off | 86591053-2856-4f25-a35c-b753f0deea8f | UINT8 | 0     | Boolean |
| char_button1     | ee5e99d1-6d7d-4d5a-9aaf-f76be25a6db8 | UINT8 | 0x3A  | keychar |
| char_button2     | 221af4c6-0695-4e21-ba9b-12fdd6612800 | UINT8 | 0x3B  | keychar |
| char_button3     | 46cbd27b-57d8-421c-8ff6-9ec75e3515d4 | UINT8 | 0x3C  | keychar |
| char_button4     | 5b975063-9256-4bdf-bd8c-d6c1688902d2 | UINT8 | 0x3D  | keychar |

<router-link to="/devices/fbrc4">НАЗАД</router-link>
